<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒªãƒ”è²·ã„ç®¡ç† - ã‚¹ãƒˆãƒƒã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#232F3E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .amazon-orange { background-color: #FF9900; }
        .amazon-dark { background-color: #232F3E; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-10">

    <header class="amazon-dark text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg font-bold">ğŸ›’ ãƒªãƒ”è²·ã„ç®¡ç†</h1>
            <div class="flex items-center gap-2">
                <span class="text-[10px] text-gray-400">Your ID:</span>
                <input type="text" id="assocId" value="your-tag-22" class="bg-gray-700 text-[10px] px-2 py-1 rounded w-20 outline-none focus:ring-1 focus:ring-orange-400">
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-lg">
        
        <div class="bg-white p-5 rounded-2xl shadow-sm mb-4 border border-gray-200">
            <h2 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                ğŸ” å•†å“ã‚’æ¢ã—ã¦ç™»éŒ²
            </h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="searchQuery" placeholder="å•†å“åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šæ´—å‰¤ï¼‰" class="flex-1 border p-3 rounded-xl text-sm outline-none focus:border-orange-400">
                <button onclick="quickSearch()" class="amazon-orange text-white px-4 rounded-xl text-sm font-bold">æ¤œç´¢</button>
            </div>
            <p class="text-[11px] text-gray-500 bg-gray-50 p-2 rounded-lg">
                â€»Amazonã§å•†å“ã‚’é–‹ãã€URLå†…ã®ã€ŒB0ã€ã‹ã‚‰å§‹ã¾ã‚‹10æ¡ã®è‹±æ•°å­—ï¼ˆASINï¼‰ã‚’ä¸‹ã®æ¬„ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚
            </p>
        </div>

        <div class="bg-white p-5 rounded-2xl shadow-sm mb-6 border border-gray-200">
            <div class="space-y-3">
                <input type="text" id="itemName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šã‚¢ãƒªã‚¨ãƒ¼ãƒ« è©°ã‚æ›¿ãˆï¼‰" class="w-full border p-3 rounded-xl text-sm outline-none focus:border-orange-400">
                <input type="text" id="asin" placeholder="ASINï¼ˆ10æ¡ã®ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’ã“ã“ã«" class="w-full border p-3 rounded-xl text-sm outline-none focus:border-orange-400">
                <textarea id="itemMemo" placeholder="è‡ªåˆ†ç”¨ãƒ¡ãƒ¢ï¼ˆä¾‹ï¼šã‚»ãƒ¼ãƒ«ã§1,000å††ä»¥ä¸‹ã®æ™‚ã«è²·ã†ï¼‰" class="w-full border p-3 rounded-xl text-sm outline-none h-20 shadow-inner bg-gray-50"></textarea>
                <button onclick="addItem()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹</button>
            </div>
        </div>

        <div id="saleBanner" class="hidden bg-red-500 text-white p-3 rounded-xl mb-6 text-sm font-bold text-center animate-bounce">
            ğŸ“£ Amazonãƒ“ãƒƒã‚°ã‚»ãƒ¼ãƒ«é–‹å‚¬ä¸­ï¼
        </div>

        <div id="itemList" class="grid gap-4 grid-cols-1">
            </div>
    </main>

    <script>
        let items = JSON.parse(localStorage.getItem('amazonStocks')) || [];
        const assocInput = document.getElementById('assocId');

        // IDã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
        if(localStorage.getItem('myAssocTag')) assocInput.value = localStorage.getItem('myAssocTag');
        assocInput.addEventListener('change', (e) => localStorage.setItem('myAssocTag', e.target.value));

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('asin')) {
                document.getElementById('asin').value = params.get('asin');
                document.getElementById('itemName').value = params.get('name') || "";
                window.scrollTo(0,0);
            }
        });

        function quickSearch() {
            const q = document.getElementById('searchQuery').value;
            if(!q) return alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            window.open(`https://www.amazon.co.jp/s?k=${encodeURIComponent(q)}`, '_blank');
        }

        function extractASIN(input) {
            const match = input.match(/\/(?:dp|gp\/product)\/([A-Z0-9]{10})/);
            return match ? match[1] : input.trim().toUpperCase();
        }

        function addItem() {
            const name = document.getElementById('itemName').value;
            const rawAsin = document.getElementById('asin').value;
            const memo = document.getElementById('itemMemo').value;
            const asin = extractASIN(rawAsin);

            if (!name || !asin) return alert('ã€Œè¡¨ç¤ºåã€ã¨ã€ŒASINã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (asin.length !== 10) return alert('ASINã¯10æ¡ã®è‹±æ•°å­—ã§ã™');

            items.push({
                id: Date.now(),
                name: name,
                asin: asin,
                memo: memo,
                lastBought: new Date().toLocaleDateString()
            });
            save();
            // Clear inputs
            document.getElementById('itemName').value = '';
            document.getElementById('asin').value = '';
            document.getElementById('itemMemo').value = '';
        }

        function save() {
            localStorage.setItem('amazonStocks', JSON.stringify(items));
            render();
        }

        function deleteItem(id) {
            if(confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                items = items.filter(i => i.id !== id);
                save();
            }
        }

        function render() {
            const list = document.getElementById('itemList');
            const tag = assocInput.value || 'your-tag-22';
            list.innerHTML = '';

            if (items.length === 0) {
                list.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">ç™»éŒ²ã•ã‚ŒãŸå•†å“ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
                return;
            }

            items.forEach(item => {
                const amazonUrl = `https://www.amazon.co.jp/dp/${item.asin}/?tag=${tag}`;
                const keepaUrl = `https://keepa.com/#!product/1-${item.asin}`;
                
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-800 pr-6">${item.name}</h3>
                        <button onclick="deleteItem(${item.id})" class="absolute top-4 right-4 text-gray-300 text-xl">âœ•</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mb-2">ASIN: ${item.asin} / å‰å›: ${item.lastBought}</p>
                    ${item.memo ? `<div class="bg-orange-50 text-orange-700 text-xs p-3 rounded-xl mb-4 border border-orange-100">ğŸ“ ${item.memo}</div>` : ''}
                    <div class="grid grid-cols-2 gap-3">
                        <a href="${keepaUrl}" target="_blank" class="flex items-center justify-center border-2 border-gray-100 text-gray-500 py-3 rounded-xl text-xs font-bold hover:bg-gray-50 transition">
                            ğŸ“Š ä¾¡æ ¼æ¨ç§»
                        </a>
                        <a href="${amazonUrl}" target="_blank" onclick="updateDate(${item.id})" class="flex items-center justify-center amazon-orange text-white py-3 rounded-xl text-sm font-bold shadow-md active:scale-95 transition">
                            å†æ³¨æ–‡ã™ã‚‹
                        </a>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function updateDate(id) {
            const item = items.find(i => i.id === id);
            if(item) item.lastBought = new Date().toLocaleDateString();
            localStorage.setItem('amazonStocks', JSON.stringify(items));
            setTimeout(render, 1000);
        }

        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }

        render();
    </script>
</body>
</html>
